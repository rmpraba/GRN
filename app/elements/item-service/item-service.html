<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="item-service">
  <template>
    <iron-ajax
      id="itemwriteAjax"
      url="{{url}}"
      method="post"
      params="{{params}}"
      handle-as="json"
      content-type="application/json"
      on-response="itemwriteResponse">
    </iron-ajax>
    <iron-ajax
      id="itemwriteAjax1"
      url="{{url1}}"
      params="{{params1}}"
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="itemwriteResponse1">
    </iron-ajax>
  </template>
  <script>
    (function() {

      Polymer({
        is: "item-service",
        ready:function()
        {
          this.length=0;
          this.no=0;
          this.url=sessionStorage.getItem("curr_sess_url")+"item-service";
          this.url1=sessionStorage.getItem("curr_sess_url")+"item-service1";
        },
        itemwriteService:function(invoiceno,invoicedate,vno,vname,dname,dno,itemarr){
          this.items=[];
          this.items=itemarr;
          this.length=this.items.length;
          var vobj={"invoiceno":"","invoicedate":"","vehno":"","vehname":"","drivername":"","driverno":""};
          vobj.invoiceno=invoiceno;
          vobj.invoicedate=invoicedate;
          vobj.vehno=vno;
          vobj.vehname=vname;
          vobj.drivername=dname;
          vobj.driverno=dno;
          this.params1=vobj;
          //alert(JSON.stringify(vobj));
          this.$.itemwriteAjax1.generateRequest();
        },
        itemwriteResponse:function(e)
        {
          if(e.detail.response.inwardregno!='not okay')
            this.no=this.no+1;
          if(this.no==this.length){
            localStorage.setItem("curr_sess_saveflag","true");
            alert("Invoice Stored: "+e.detail.response.inwardregno);
          }
        },
        itemwriteResponse1:function(e)
        {
          //alert(e.detail.response);
          if(e.detail.response.returnval=="succ"){
            for(var i=0;i<this.items.length;i++){
              var obj={"invoiceno":"","invoicedate":"","supplier":"","itemdes":"","qtyreceived":"","remark":"","unit":""};
              obj.invoiceno=this.items[i].invoiceno;
              obj.invoicedate=this.items[i].invoicedate;
              obj.supplier=this.items[i].supplier;
              obj.itemdes=this.items[i].itemdes;
              obj.qtyreceived=this.items[i].qtyreceive;
              obj.unit=this.items[i].unit;
              obj.remark=this.items[i].remark;
              this.params=obj;
              this.$.itemwriteAjax.generateRequest();
            }
          }
          else if(e.detail.response.returnval=="exists"){
            alert("Invoice already exist....Create new invoice...!");
          }
        }
      });
    })();
  </script>
</dom-module>
